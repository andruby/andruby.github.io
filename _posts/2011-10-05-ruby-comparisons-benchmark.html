---
layout: post
title: Ruby comparisons benchmark
tags: []
status: publish
type: post
published: true
meta: {}
---
I recently had to make a huge loop faster (about 10 milllion iterations).<div>The loop spent quite some time checking the state of an object, so I benchmarked some different comparisons in Ruby, on different ruby implementations (Rubinius 2.0.0 pre, MRI 1.9.2-p290 and REE-1.8.7)</div><p /><div><div class="data">    <table class="lines highlight" cellspacing="0" cellpadding="0">      <tr>        <td class="line_numbers">          <span rel="file-comparison-rb-L1" id="file-comparison-rb-L1">1</span>          <span rel="file-comparison-rb-L2" id="file-comparison-rb-L2">2</span>          <span rel="file-comparison-rb-L3" id="file-comparison-rb-L3">3</span>          <span rel="file-comparison-rb-L4" id="file-comparison-rb-L4">4</span>          <span rel="file-comparison-rb-L5" id="file-comparison-rb-L5">5</span>          <span rel="file-comparison-rb-L6" id="file-comparison-rb-L6">6</span>          <span rel="file-comparison-rb-L7" id="file-comparison-rb-L7">7</span>          <span rel="file-comparison-rb-L8" id="file-comparison-rb-L8">8</span>          <span rel="file-comparison-rb-L9" id="file-comparison-rb-L9">9</span>          <span rel="file-comparison-rb-L10" id="file-comparison-rb-L10">10</span>          <span rel="file-comparison-rb-L11" id="file-comparison-rb-L11">11</span>          <span rel="file-comparison-rb-L12" id="file-comparison-rb-L12">12</span>          <span rel="file-comparison-rb-L13" id="file-comparison-rb-L13">13</span>          <span rel="file-comparison-rb-L14" id="file-comparison-rb-L14">14</span>          <span rel="file-comparison-rb-L15" id="file-comparison-rb-L15">15</span>          <span rel="file-comparison-rb-L16" id="file-comparison-rb-L16">16</span>          <span rel="file-comparison-rb-L17" id="file-comparison-rb-L17">17</span>          <span rel="file-comparison-rb-L18" id="file-comparison-rb-L18">18</span>          <span rel="file-comparison-rb-L19" id="file-comparison-rb-L19">19</span>          <span rel="file-comparison-rb-L20" id="file-comparison-rb-L20">20</span>          <span rel="file-comparison-rb-L21" id="file-comparison-rb-L21">21</span>          <span rel="file-comparison-rb-L22" id="file-comparison-rb-L22">22</span>          <span rel="file-comparison-rb-L23" id="file-comparison-rb-L23">23</span>          <span rel="file-comparison-rb-L24" id="file-comparison-rb-L24">24</span>          <span rel="file-comparison-rb-L25" id="file-comparison-rb-L25">25</span>          <span rel="file-comparison-rb-L26" id="file-comparison-rb-L26">26</span>          <span rel="file-comparison-rb-L27" id="file-comparison-rb-L27">27</span>          <span rel="file-comparison-rb-L28" id="file-comparison-rb-L28">28</span>          <span rel="file-comparison-rb-L29" id="file-comparison-rb-L29">29</span>          <span rel="file-comparison-rb-L30" id="file-comparison-rb-L30">30</span>          <span rel="file-comparison-rb-L31" id="file-comparison-rb-L31">31</span>          <span rel="file-comparison-rb-L32" id="file-comparison-rb-L32">32</span>          <span rel="file-comparison-rb-L33" id="file-comparison-rb-L33">33</span>          <span rel="file-comparison-rb-L34" id="file-comparison-rb-L34">34</span>        </td>        <td class="line_data" width="100%">          <pre /><div class="line" id="file-comparison-rb-LC1"><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC2">&nbsp;</div></pre>          <pre /><div class="line" id="file-comparison-rb-LC3"><span class="k">def</span> <span class="nf">is_it_true?</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC4">  <span class="kp">true</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC5"><span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC6">&nbsp;</div></pre>          <pre /><div class="line" id="file-comparison-rb-LC7"><span class="no">CONSTANT</span> <span class="o">=</span> <span class="mi">1</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC8"><span class="no">BenchTimes</span> <span class="o">=</span> <span class="mi">1_000_000</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC9">&nbsp;</div></pre>          <pre /><div class="line" id="file-comparison-rb-LC10"><span class="no">Benchmark</span><span class="o">.</span><span class="n">bm</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">bm</span><span class="o">|</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC11">  <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;String compare&quot;</span><span class="p">)</span> <span class="k">do</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC12">    <span class="no">BenchTimes</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="s1">&#39;string&#39;</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC13">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC14">  <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Symbol compare&quot;</span><span class="p">)</span> <span class="k">do</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC15">    <span class="no">BenchTimes</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="ss">:symbol</span> <span class="o">==</span> <span class="ss">:symbol</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC16">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC17">  <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Integer compare&quot;</span><span class="p">)</span> <span class="k">do</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC18">    <span class="no">BenchTimes</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="mi">42</span> <span class="o">==</span> <span class="mi">42</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC19">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC20">  <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;Constant int compare&quot;</span><span class="p">)</span> <span class="k">do</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC21">    <span class="no">BenchTimes</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="no">CONSTANT</span> <span class="o">==</span> <span class="no">CONSTANT</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC22">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC23">  <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;method call&quot;</span><span class="p">)</span> <span class="k">do</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC24">    <span class="no">BenchTimes</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="n">is_it_true?</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC25">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC26">  <span class="n">obj</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">new</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC27">  <span class="n">bm</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;method definition&quot;</span><span class="p">)</span> <span class="k">do</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC28">    <span class="no">BenchTimes</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> </div></pre>          <pre /><div class="line" id="file-comparison-rb-LC29">      <span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">new_method</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC30">        <span class="kp">true</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC31">      <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC32">    <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC33">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-comparison-rb-LC34"><span class="k">end</span></div></pre>        </td>      </tr>    </table>  </div></div><p /><div>Conclusions:<br /><ul><li>Comparing symbols is a faster than comparing strings (2.0x~2.5x)</li><li>Integer comparison is even faster (2x in Rubinius, 1.4x in Ruby 1.9.2)</li><li>Using constants that point to integers carries no overhead in 1.9.2, ~25% in ree-1.8.7 and rbx</li></ul><br />Between implementations:<br /><ul><li>Method calling: Rubinius is ~2x faster than Ruby 1.9.2, who in turn is ~2x faster than ree-1.8.7</li><li>Comparing symbols, integers and integer constants in Rubinius is ~as fast as calling a (boolean) method.</li><li>BUT: defining methods on the fly in Rubinius-2.0.0pre is 2x slower than regular Ruby</li><li>Ruby 1.9.2 has significantly faster comparisons than ree-1.8.7</li></ul><div>I might switch from string comparison to symbol (or constant integer) comparison in heavy loops.</div><br />NOTE:&nbsp;Benches were run on a 2011 MacBook Pro 2.66 Ghz Core i7.</div>
