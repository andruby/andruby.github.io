---
layout: post
title: Ruby 1.8 vs 1.9 group_by performance
tags:
- ruby
status: publish
type: post
published: true
meta: {}
---
<p>I am working on a ruby project which has cpu intensive tasks so I wanted to see what the impact would be of using the ruby 1.9 development version. It is supposed to provide a major performance increase.</p><p>The task used in this project crunches a large amount of data using mathematical functions, array sorting/grouping and database writes.</p><p>Ruby versions used for this test:</p><div class="CodeRay">  <div class="code"><pre>ruby 1.8.6 (2007-03-13 patchlevel 0) [i686-darwin8.10.1]ruby 1.9.0 (2008-07-25 revision 18217) [i686-darwin9]</pre></div></div><p>A typical run would take 240sec using ruby 1.8 and 205s with ruby 1.9 without any adaptations: A ~15% speed increase!</p><p>I dug a little deeper and found that the array.group_by method was performing a lot faster in ruby 1.9 so i wrote this benchmark to test the increase.</p><p><!--more--><div class="data">    <table class="lines highlight" cellspacing="0" cellpadding="0">      <tr>        <td class="line_numbers">          <span rel="file-gistfile1-rb-L1" id="file-gistfile1-rb-L1">1</span>          <span rel="file-gistfile1-rb-L2" id="file-gistfile1-rb-L2">2</span>          <span rel="file-gistfile1-rb-L3" id="file-gistfile1-rb-L3">3</span>          <span rel="file-gistfile1-rb-L4" id="file-gistfile1-rb-L4">4</span>          <span rel="file-gistfile1-rb-L5" id="file-gistfile1-rb-L5">5</span>          <span rel="file-gistfile1-rb-L6" id="file-gistfile1-rb-L6">6</span>          <span rel="file-gistfile1-rb-L7" id="file-gistfile1-rb-L7">7</span>          <span rel="file-gistfile1-rb-L8" id="file-gistfile1-rb-L8">8</span>          <span rel="file-gistfile1-rb-L9" id="file-gistfile1-rb-L9">9</span>          <span rel="file-gistfile1-rb-L10" id="file-gistfile1-rb-L10">10</span>          <span rel="file-gistfile1-rb-L11" id="file-gistfile1-rb-L11">11</span>          <span rel="file-gistfile1-rb-L12" id="file-gistfile1-rb-L12">12</span>          <span rel="file-gistfile1-rb-L13" id="file-gistfile1-rb-L13">13</span>          <span rel="file-gistfile1-rb-L14" id="file-gistfile1-rb-L14">14</span>          <span rel="file-gistfile1-rb-L15" id="file-gistfile1-rb-L15">15</span>          <span rel="file-gistfile1-rb-L16" id="file-gistfile1-rb-L16">16</span>          <span rel="file-gistfile1-rb-L17" id="file-gistfile1-rb-L17">17</span>          <span rel="file-gistfile1-rb-L18" id="file-gistfile1-rb-L18">18</span>          <span rel="file-gistfile1-rb-L19" id="file-gistfile1-rb-L19">19</span>          <span rel="file-gistfile1-rb-L20" id="file-gistfile1-rb-L20">20</span>          <span rel="file-gistfile1-rb-L21" id="file-gistfile1-rb-L21">21</span>          <span rel="file-gistfile1-rb-L22" id="file-gistfile1-rb-L22">22</span>          <span rel="file-gistfile1-rb-L23" id="file-gistfile1-rb-L23">23</span>          <span rel="file-gistfile1-rb-L24" id="file-gistfile1-rb-L24">24</span>          <span rel="file-gistfile1-rb-L25" id="file-gistfile1-rb-L25">25</span>          <span rel="file-gistfile1-rb-L26" id="file-gistfile1-rb-L26">26</span>          <span rel="file-gistfile1-rb-L27" id="file-gistfile1-rb-L27">27</span>          <span rel="file-gistfile1-rb-L28" id="file-gistfile1-rb-L28">28</span>          <span rel="file-gistfile1-rb-L29" id="file-gistfile1-rb-L29">29</span>          <span rel="file-gistfile1-rb-L30" id="file-gistfile1-rb-L30">30</span>          <span rel="file-gistfile1-rb-L31" id="file-gistfile1-rb-L31">31</span>          <span rel="file-gistfile1-rb-L32" id="file-gistfile1-rb-L32">32</span>        </td>        <td class="line_data" width="100%">          <pre /><div class="line" id="file-gistfile1-rb-LC1"><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC2"><span class="nb">require</span> <span class="s1">&#39;activesupport&#39;</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC3"><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC4"><span class="kp">include</span> <span class="no">Benchmark</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC5">&nbsp;</div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC6"><span class="k">class</span> <span class="nc">T</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC7">  <span class="kp">attr_accessor</span> <span class="ss">:date</span><span class="p">,</span> <span class="ss">:count</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC8">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">_date</span><span class="p">,</span><span class="n">_count</span><span class="p">)</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC9">    <span class="vi">@count</span> <span class="o">=</span> <span class="n">_count</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC10">    <span class="vi">@date</span> <span class="o">=</span> <span class="n">_date</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC11">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC12"><span class="k">end</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC13">&nbsp;</div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC14">&nbsp;</div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC15"><span class="k">def</span> <span class="nf">fill_array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC16">  <span class="n">a</span> <span class="o">=</span> <span class="o">[]</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC17">  <span class="n">random_dates</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">5</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC18">  <span class="n">n</span><span class="o">.</span><span class="n">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="n">T</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">rand</span><span class="p">(</span><span class="n">random_dates</span><span class="p">)</span><span class="o">.</span><span class="n">days</span><span class="o">.</span><span class="n">ago</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC19">  <span class="k">return</span> <span class="n">a</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC20"><span class="k">end</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC21">&nbsp;</div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC22"><span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC23">  <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="nb">p</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC24">  <span class="nb">puts</span> <span class="s2">&quot;=== 10^</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2"> ===&quot;</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC25">  <span class="n">array</span> <span class="o">=</span> <span class="o">[]</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC26">  <span class="n">benchmark</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC27">    <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;filling array     : &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">array</span> <span class="o">=</span> <span class="n">fill_array</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC28">    <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;group_by (Time)   : &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">array</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="o">.</span><span class="n">date</span> <span class="p">}</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC29">    <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;group_by (Date)   : &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">array</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span> <span class="p">}</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC30">    <span class="n">x</span><span class="o">.</span><span class="n">report</span><span class="p">(</span><span class="s2">&quot;group_by (String) : &quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">array</span><span class="o">.</span><span class="n">group_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">r</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">to_date</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span> <span class="p">}</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC31">  <span class="k">end</span></div></pre>          <pre /><div class="line" id="file-gistfile1-rb-LC32"><span class="k">end</span></div></pre>        </td>      </tr>    </table>  </div></p><p>&nbsp;</p><p>On ruby 1.8 this only runs upto 10^4, 10^5 took way too long for Time and Date grouping.</p><div class="CodeRay">  <div class="code"><pre>=== 10^2 ===filling array     :   0.030000   0.000000   0.030000 (  0.023987)group_by (Time)   :   0.030000   0.000000   0.030000 (  0.032630)group_by (Date)   :   0.010000   0.000000   0.010000 (  0.012132)group_by (String) :   0.020000   0.000000   0.020000 (  0.019727)=== 10^3 ===filling array     :   0.300000   0.000000   0.300000 (  0.305314)group_by (Time)   :   4.270000   0.020000   4.290000 (  4.306768)group_by (Date)   :   0.610000   0.000000   0.610000 (  0.622509)group_by (String) :   0.260000   0.000000   0.260000 (  0.258966)=== 10^4 ===filling array     :   3.050000   0.030000   3.080000 (  3.094591)group_by (Time)   : 425.980000   2.250000 428.230000 (433.534167)group_by (Date)   :  53.930000   0.300000  54.230000 ( 54.870563)group_by (String) :   5.440000   0.010000   5.450000 (  5.480042)=== 10^5 ===filling array     :  31.680000   0.240000  31.920000 ( 32.714948)group_by (Time)   :  --- too long ---group_by (Date)   :  --- too long ---group_by (String) : 796.560000   5.540000 802.100000 (815.322759)</pre></div></div><p>Another thing to note is that grouping by Time is a lot more expensive than grouping by Date. Grouping by String is even faster. This is the exact opposite of ruby 1.9 behavior:</p><div class="CodeRay">  <div class="code"><pre>=== 10^2 ===filling array     :   0.030000   0.000000   0.030000 (  0.022190)group_by (Time)   :   0.000000   0.000000   0.000000 (  0.000217)group_by (Date)   :   0.000000   0.000000   0.000000 (  0.001032)group_by (String) :   0.000000   0.000000   0.000000 (  0.004109)=== 10^3 ===filling array     :   0.110000   0.000000   0.110000 (  0.107807)group_by (Time)   :   0.000000   0.000000   0.000000 (  0.001625)group_by (Date)   :   0.010000   0.000000   0.010000 (  0.011684)group_by (String) :   0.050000   0.000000   0.050000 (  0.061122)=== 10^4 ===filling array     :   0.940000   0.010000   0.950000 (  0.975104)group_by (Time)   :   0.020000   0.000000   0.020000 (  0.018976)group_by (Date)   :   0.140000   0.000000   0.140000 (  0.134740)group_by (String) :   0.390000   0.010000   0.400000 (  0.400235)=== 10^5 ===filling array     :   9.290000   0.130000   9.420000 (  9.711327)group_by (Time)   :   0.300000   0.000000   0.300000 (  0.312848)group_by (Date)   :   1.360000   0.020000   1.380000 (  1.391566)group_by (String) :   4.100000   0.040000   4.140000 (  4.194526)</pre></div></div><p>With ruby 1.9, grouping by Time is faster than Date. Grouping by String is the slowest. Important to note is that the increase is almost linear.</p><p>If we look at the difference between 1.8 and 1.9 we see that filling an array with objects is 3 times faster. But the real surprise is the exponential speed increase when grouping large dataset!</p><p>[ad#banner_ad]</p>
